pipeline {
    agent any
    stages {
        stage('git pull') {
            steps {
                checkout scm
                echo 'project pulled from git'
            }
        }
        stage('docker build backend') {
            steps {
                script {

                    def prevBuild = BUILD_NUMBER.toInteger() - 1
                    sh ''' 
                         if [ "$(docker ps -q)" ]; then
                            docker rm -f $(docker ps -aq --filter "name=container_")
                         fi      
                    '''
                    
                    def dockerImg = docker.build("swaraj9/backend:${BUILD_NUMBER}", './backend')
                    def dockerRun = dockerImg.run("-p 5000:80 --name container_${BUILD_NUMBER}")
                    docker.withRegistry('https://index.docker.io/v1/', 'docker-cred') {
                            dockerImg.push("${BUILD_NUMBER}")
                            dockerImg.push('latest')
                    }
                }
            }
        }
    }
}
